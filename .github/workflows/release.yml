name: Gemini AI Release Notes

on:
    push:
        tags: ["*"]
    workflow_dispatch:

jobs:
    release-ai:
        runs-on: ubuntu-latest
        permissions:
            contents: write

        steps:
            - name: Checkout Code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                  python-version: "3.10"

            - name: Install Dependencies
              run: pip install -q -U google-genai

            - name: Generate Notes
              env:
                  GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
                  TAG_NAME: ${{ github.ref_name }}
              run: |
                  # 1. Definição do intervalo de análise
                  LATEST_TAG=$TAG_NAME
                  if [[ "${{ github.event_name }}" == "workflow_dispatch" || "$LATEST_TAG" == "master" || "$LATEST_TAG" == "main" ]]; then
                    LATEST_TAG="HEAD"
                  fi
                  PREVIOUS_TAG=$(git describe --tags --abbrev=0 $LATEST_TAG^ 2>/dev/null || echo "")

                  # 2. Filtros para ignorar arquivos de infraestrutura e scripts
                  EXCLUDE_PATH=':(exclude).github/* :(exclude)*.py :(exclude)scripts/*'

                  git log ${PREVIOUS_TAG:+$PREVIOUS_TAG..}$LATEST_TAG --oneline -- . $EXCLUDE_PATH > commits.txt
                  git diff ${PREVIOUS_TAG:+$PREVIOUS_TAG..}$LATEST_TAG -- . $EXCLUDE_PATH > changes.diff

                  # 3. Script Python Robusto (com 'EOF' para evitar erro de Syntax)
                  python - <<'EOF'
                  import os
                  from google import genai
                  from google.genai import types

                  try:
                      client = genai.Client(
                          api_key=os.environ['GEMINI_API_KEY'],
                          http_options={'api_version': 'v1'}
                      )
                      
                      with open('commits.txt', 'r') as f: commits = f.read()
                      with open('changes.diff', 'r') as f: diff = f.read()[:7000]

                      tag_display = os.environ.get('TAG_NAME', 'latest')
                      
                      if not commits.strip():
                          commits = "Internal maintenance and updates."

                      sys_instr = "You are a professional tool. Output ONLY raw Markdown. No conversational text, no greetings, no backticks."
                      prompt = f"Write release notes in English for version {tag_display}.\nCommits: {commits}\nDiff: {diff}"

                      response = client.models.generate_content(
                          model="gemini-2.5-flash",
                          config=types.GenerateContentConfig(system_instruction=sys_instr),
                          contents=prompt
                      )
                      
                      content = response.text.strip()
                      
                      # Limpeza de blocos de código Markdown indesejados
                      if content.startswith("```"):
                          content = "\n".join([l for l in content.splitlines() if not l.startswith("```")])
                      
                      if "#" in content:
                          content = content[content.find("#"):]

                      with open('gemini_notes.md', 'w', encoding='utf-8') as f:
                          f.write(content.strip())
                  except Exception as e:
                      tag_display = os.environ.get('TAG_NAME', 'Manual')
                      with open('gemini_notes.md', 'w', encoding='utf-8') as f:
                          f.write(f"# Release {tag_display}\n\n⚠️ AI failed. Commits:\n{commits}")
                  EOF

            - name: Create Release
              uses: softprops/action-gh-release@v1
              with:
                  body_path: gemini_notes.md
                  tag_name: ${{ github.ref_name }}
                  name: Release ${{ github.ref_name }}
                  draft: true
                  files: |
                      main.js
                      manifest.json
                      styles.css
                      versions.json
