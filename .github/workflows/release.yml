name: Gemini AI Release Notes

on:
    push:
        tags: ["*"]
    workflow_dispatch:

jobs:
    release-ai:
        runs-on: ubuntu-latest
        permissions:
            contents: write

        steps:
            - name: Checkout Code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                  python-version: "3.10"

            - name: Install Dependencies
              run: pip install -q -U google-generativeai

            - name: Generate Notes
              env:
                  GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
                  TAG_NAME: ${{ github.ref_name }}
              run: |
                  # 1. Coleta dados do Git
                  LATEST_TAG=$TAG_NAME
                  if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
                    LATEST_TAG=$(git describe --tags --abbrev=0)
                  fi
                  PREVIOUS_TAG=$(git describe --tags --abbrev=0 $LATEST_TAG^ 2>/dev/null || echo "")

                  git log $PREVIOUS_TAG..$LATEST_TAG --oneline > commits.txt
                  git diff $PREVIOUS_TAG..$LATEST_TAG > changes.diff

                  # 2. Roda o script Python (Gera o arquivo gemini_notes.md)
                  python - <<EOF
                  import os
                  import google.generativeai as genai

                  genai.configure(api_key=os.environ['GEMINI_API_KEY'])
                  model = genai.GenerativeModel('gemini-1.5-flash')

                  commits = open('commits.txt').read()
                  diff = open('changes.diff').read()[:5000] # Limite de seguranca

                  prompt = f"""Write professional Release Notes in English for version {os.environ['TAG_NAME']}.
                  Structure: ðŸš€ Features, ðŸ› Bug Fixes, âš™ï¸ Technical Changes.

                  COMMITS:
                  {commits}

                  DIFF:
                  {diff}"""

                  try:
                      response = model.generate_content(prompt)
                      with open('gemini_notes.md', 'w') as f:
                          f.write(response.text)
                  except Exception as e:
                      with open('gemini_notes.md', 'w') as f:
                          f.write(f"Release {os.environ['TAG_NAME']}\n\nAutomated notes unavailable.\n\nCommits:\n{commits}")
                  EOF

            - name: Create Release
              uses: softprops/action-gh-release@v1
              with:
                  body_path: gemini_notes.md
                  tag_name: ${{ github.ref_name }}
                  name: Release ${{ github.ref_name }}
                  draft: true
