name: Gemini AI Release Notes

on:
    push:
        tags:
            - "*"
    workflow_dispatch:

jobs:
    release-ai:
        runs-on: ubuntu-latest
        permissions:
            contents: write

        steps:
            - name: Checkout Code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Get Changes (Diff & Logs)
              id: get_changes
              run: |
                  # Se rodar por tag, usa a tag. Se rodar manual, usa a √∫ltima tag do repo.
                  LATEST_TAG=${{ github.ref_name }}
                  if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
                    LATEST_TAG=$(git describe --tags --abbrev=0)
                  fi

                  PREVIOUS_TAG=$(git describe --tags --abbrev=0 $LATEST_TAG^ 2>/dev/null || echo "")

                  echo "Analysing changes for $LATEST_TAG since $PREVIOUS_TAG"

                  if [ -z "$PREVIOUS_TAG" ]; then
                    git log --oneline > commits.txt
                    git diff > changes.diff
                  else
                    git log $PREVIOUS_TAG..$LATEST_TAG --oneline > commits.txt
                    git diff $PREVIOUS_TAG..$LATEST_TAG > changes.diff
                  fi

            - name: Generate Release Notes with Gemini
              uses: google-github-actions/run-gemini-cli@v0
              env:
                  GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
              with:
                  prompt: |
                      You are a Senior Software Engineer. Write professional Release Notes in English for version $LATEST_TAG.

                      Structure:
                      ## üöÄ Features
                      ## üêõ Bug Fixes
                      ## ‚öôÔ∏è Technical Changes

                      COMMITS:
                      $(cat commits.txt)

                      DIFF:
                      $(cat changes.diff | head -c 8000)
                  output_file: gemini_notes.md

            - name: Create or Update GitHub Release
              uses: softprops/action-gh-release@v1
              with:
                  body_path: gemini_notes.md
                  tag_name: ${{ github.ref_name }}
                  name: Release ${{ github.ref_name }}
                  draft: true
