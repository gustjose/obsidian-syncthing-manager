name: Gemini AI Release Notes

on:
    push:
        tags: ["*"]
    workflow_dispatch:

jobs:
    release-ai:
        runs-on: ubuntu-latest
        permissions:
            contents: write

        steps:
            - name: Checkout Code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                  python-version: "3.10"

            - name: Install Dependencies
              run: pip install -q -U google-genai

            - name: Generate Notes
              env:
                  GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
                  GITHUB_REF_NAME: ${{ github.ref_name }}
                  GITHUB_EVENT_NAME: ${{ github.event_name }}
              run: |
                  # 1. Preparação do Git
                  LATEST_TAG=$GITHUB_REF_NAME
                  if [[ "$GITHUB_EVENT_NAME" == "workflow_dispatch" || "$LATEST_TAG" == "master" ]]; then
                    LATEST_TAG="HEAD"
                  fi
                  PREVIOUS_TAG=$(git describe --tags --abbrev=0 $LATEST_TAG^ 2>/dev/null || echo "")

                  EXCLUDE_PATH=':(exclude).github/* :(exclude)*.py :(exclude)scripts/*'
                  git log ${PREVIOUS_TAG:+$PREVIOUS_TAG..}$LATEST_TAG --oneline -- . $EXCLUDE_PATH > commits.txt
                  git diff ${PREVIOUS_TAG:+$PREVIOUS_TAG..}$LATEST_TAG -- . $EXCLUDE_PATH > changes.diff

                  # 2. Script Python (Ajustado para evitar conflito de chaves {{ }})
                  python - <<'EOF'
                  import os
                  from google import genai
                  from google.genai import types

                  try:
                      # Usamos uma inicialização mais simples para evitar conflito de sintaxe no YAML
                      client = genai.Client(api_key=os.environ.get('GEMINI_API_KEY'))
                      
                      with open('commits.txt', 'r') as f: commits = f.read()
                      with open('changes.diff', 'r') as f: diff = f.read()[:7000]

                      tag_name = os.environ.get('GITHUB_REF_NAME', 'latest')
                      
                      if not commits.strip() or len(commits) < 5:
                          commits = "Internal updates and maintenance."

                      sys_instr = "You are a specialized tool. Output ONLY raw Markdown. No conversational text, no greetings, no backticks."
                      prompt = f"Write professional release notes in English for version {tag_name}.\n\nCOMMITS:\n{commits}\n\nDIFF:\n{diff}"

                      response = client.models.generate_content(
                          model="gemini-2.5-flash",
                          config=types.GenerateContentConfig(system_instruction=sys_instr),
                          contents=prompt
                      )
                      
                      content = response.text.strip()
                      
                      # Limpeza de possíveis blocos de código
                      if content.startswith("```"):
                          content = "\n".join([l for l in content.splitlines() if not l.startswith("```")])
                      
                      if "#" in content:
                          content = content[content.find("#"):]

                      with open('gemini_notes.md', 'w', encoding='utf-8') as f:
                          f.write(content.strip())
                  except Exception as e:
                      tag_name = os.environ.get('GITHUB_REF_NAME', 'Manual')
                      with open('gemini_notes.md', 'w', encoding='utf-8') as f:
                          f.write(f"# Release {tag_name}\n\n⚠️ AI generation failed. Check action logs.\n\n## Commits\n{commits}")
                  EOF

            - name: Create Release
              uses: softprops/action-gh-release@v1
              with:
                  body_path: gemini_notes.md
                  tag_name: ${{ github.ref_name }}
                  name: Release ${{ github.ref_name }}
                  draft: true
                  files: |
                      main.js
                      manifest.json
                      styles.css
                      versions.json
