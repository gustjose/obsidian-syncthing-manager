name: Gemini AI Release Notes

on:
    push:
        tags:
            - "*"
    workflow_dispatch:

jobs:
    release-ai:
        runs-on: ubuntu-latest
        permissions:
            contents: write

        steps:
            - name: Checkout Code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Prepare Prompt and Context
              id: prepare_data
              run: |
                  # Identifica as tags
                  LATEST_TAG=${{ github.ref_name }}
                  if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
                    LATEST_TAG=$(git describe --tags --abbrev=0)
                  fi
                  PREVIOUS_TAG=$(git describe --tags --abbrev=0 $LATEST_TAG^ 2>/dev/null || echo "")

                  # Coleta commits e diff
                  if [ -z "$PREVIOUS_TAG" ]; then
                    git log --oneline > commits.txt
                    git diff > changes.diff
                  else
                    git log $PREVIOUS_TAG..$LATEST_TAG --oneline > commits.txt
                    git diff $PREVIOUS_TAG..$LATEST_TAG > changes.diff
                  fi

                  # Monta o arquivo de prompt final para evitar erros de interpolaÃ§Ã£o no YAML
                  echo "You are a Senior Software Engineer. Write professional Release Notes in English for version $LATEST_TAG." > final_prompt.txt
                  echo -e "\nSTRUCTURE:" >> final_prompt.txt
                  echo -e "## ðŸš€ Features\n## ðŸ› Bug Fixes\n## âš™ï¸ Technical Changes\n" >> final_prompt.txt
                  echo "COMMITS:" >> final_prompt.txt
                  cat commits.txt >> final_prompt.txt
                  echo -e "\nDIFF:" >> final_prompt.txt
                  cat changes.diff | head -c 5000 >> final_prompt.txt

            - name: Generate Release Notes with Gemini
              uses: google-github-actions/run-gemini-cli@v0
              id: gemini_step
              with:
                  gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
                  gemini_model: "gemini-1.5-flash"
                  # Passamos o conteÃºdo do arquivo criado no passo anterior
                  prompt: "$(cat final_prompt.txt)"

            - name: Save Gemini Output to File
              run: |
                  # Captura a resposta da IA. Se estiver vazia, gera um fallback bÃ¡sico.
                  RESPONSE="${{ steps.gemini_step.outputs.gemini_response }}"
                  if [ -z "$RESPONSE" ] || [ "$RESPONSE" == "null" ]; then
                    echo "## Release ${{ github.ref_name }}" > gemini_notes.md
                    echo "AI generation failed. Please check the commits manually." >> gemini_notes.md
                    cat commits.txt >> gemini_notes.md
                  else
                    echo "$RESPONSE" > gemini_notes.md
                  fi

            - name: Create or Update GitHub Release
              uses: softprops/action-gh-release@v1
              with:
                  body_path: gemini_notes.md
                  tag_name: ${{ github.ref_name }}
                  name: Release ${{ github.ref_name }}
                  draft: true
