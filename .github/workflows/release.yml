name: AI Release

on:
    push:
        tags:
            - "*"

jobs:
    build-release:
        runs-on: ubuntu-latest
        permissions:
            contents: write

        steps:
            - name: Checkout Code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"

            - name: Install NPM Dependencies and Build
              run: |
                  npm install
                  npm run build

            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                  python-version: "3.10"

            - name: Install Python Dependencies
              run: pip install google-genai

            - name: Get Git Data
              run: |
                  # Define o intervalo de comparação (da tag anterior até a atual)
                  PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || git rev-list --max-parents=0 HEAD)

                  # Git Log com exclusão
                  git log $PREVIOUS_TAG..HEAD --pretty=format:"- %s" -- . ":(exclude).github/workflows" ":(exclude)scripts" > commits.txt

                  # Git Diff com exclusão
                  git diff $PREVIOUS_TAG..HEAD -- . ":(exclude).github/workflows" ":(exclude)scripts" > changes.diff

            - name: Generate Notes with Gemini
              env:
                  GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
                  TAG_NAME: ${{ github.ref_name }}
              run: python .github/workflows/generate_notes.py

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v1
              with:
                  body_path: gemini_notes.md
                  name: ${{ github.ref_name }}
                  draft: true
                  prerelease: false
                  files: |
                      main.js
                      manifest.json
                      styles.css
                      versions.json
