name: Gemini AI Release Notes

on:
    push:
        tags: ["*"]
    workflow_dispatch:

jobs:
    release-ai:
        runs-on: ubuntu-latest
        permissions:
            contents: write

        steps:
            - name: Checkout Code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                  python-version: "3.10"

            - name: Install Dependencies
              run: pip install -q -U google-genai

            - name: Generate Notes
              env:
                  GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
                  TAG_NAME: ${{ github.ref_name }}
              run: |
                  LATEST_TAG=$TAG_NAME
                  if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
                    LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "latest")
                  fi
                  PREVIOUS_TAG=$(git describe --tags --abbrev=0 $LATEST_TAG^ 2>/dev/null || echo "")

                  git log $PREVIOUS_TAG..$LATEST_TAG --oneline > commits.txt
                  git diff $PREVIOUS_TAG..$LATEST_TAG > changes.diff

                  python - <<EOF
                  import os
                  from google import genai

                  # Nova sintaxe da biblioteca google-genai
                  client = genai.Client(api_key=os.environ['GEMINI_API_KEY'])

                  try:
                      with open('commits.txt', 'r') as f: commits = f.read()
                      with open('changes.diff', 'r') as f: diff = f.read()[:7000]

                      prompt = f"""You are a Senior Software Engineer. Generate professional release notes in Markdown.
                      Version: {os.environ['TAG_NAME']}
                      
                      Structure:
                      ## ðŸš€ Features
                      ## ðŸ› Bug Fixes
                      ## âš™ï¸ Technical Changes

                      COMMITS:
                      {commits}

                      DIFF:
                      {diff}
                      """

                      # Chamada atualizada para o modelo 2.0
                      response = client.models.generate_content(
                          model="gemini-1.5-flash",
                          contents=prompt
                      )
                      
                      with open('gemini_notes.md', 'w', encoding='utf-8') as f:
                          f.write(response.text)

                  except Exception as e:
                      # Fallback melhor estruturado em Markdown caso a IA falhe
                      with open('gemini_notes.md', 'w', encoding='utf-8') as f:
                          f.write(f"# Release {os.environ['TAG_NAME']}\n\n")
                          f.write("âš ï¸ *AI Generation failed, listing commits manually:*\n\n")
                          f.write("## ðŸ“ Commits\n")
                          with open('commits.txt', 'r') as c: f.write(c.read())
                          print(f"Error detail: {e}")
                  EOF

            - name: Create Release
              uses: softprops/action-gh-release@v1
              with:
                  body_path: gemini_notes.md
                  tag_name: ${{ github.ref_name }}
                  name: Release ${{ github.ref_name }}
                  draft: true
